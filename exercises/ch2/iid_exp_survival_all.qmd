
### Exercise 2.8

{{< include /exercises/book_exercises/oneparam/iid_exp_survival_all.tex >}}

::: {#q:iid_exp_survival_all .callout-note icon="false" collapse="true"}
## Solution 

```{r}
#| output: false
library(tidyverse) # loads data manipulation and visualization packages
library(survival) # loads the lung cancer data as `lung`
colors = c("#6C8EBF", "#c0a34d", "#780000","#007878","#B5C6DF","#EADAAA","#AE6666")
```

The likelihood for all data, censored and uncensored, is 
$$
\begin{align}
p(x_1,\ldots,x_n \vert \theta) & = \prod_{i=1}^n p(x_i \vert \theta) \\
& = \prod_{u \in \mathcal{U}} p(x_u \vert \theta) \prod_{c \in \mathcal{C}} p(x_c \vert \theta) \\
& = \prod_{u \in \mathcal{U}} p(x_u \vert \theta) \prod_{c \in \mathcal{C}} \left(1 - F(x_c \vert \theta)\right) 
\end{align}
$$
where $\mathcal{U}$ and $\mathcal{C}$ are the sets of observation indicies for the uncensored and censored data, respectively. The likelihood for the uncensored data (the first product) is the same as before
$$
\prod_{u \in \mathcal{U}} p(x_u \vert \theta) = \prod_{u \in \mathcal{U}} \theta e^{-\theta x_u} = \theta^{n_u} e^{-\theta\sum_{u \in \mathcal{U}} x_u},
$$
where $n_u$ is the number of uncensored observations. The likelihood contribution for each observation in the censored set (the second product) is the survival function
$$
\mathrm{Pr}(X \geq x_c) = 1 - F(x_c \vert \theta),
$$
where $F(x_c \vert \theta) = 1 - e^{-x_c \theta}$ is the cumulative distribution function of the exponential distribution evaluated at $x_c$.

So the likelihood function is
$$
p(x_1,\ldots,x_n \vert \theta) = \theta^n e^{-\theta\sum_{u \in \mathcal{U}} x_u} \times e^{-\theta \sum_{u \in \mathcal{U}} x_c} = \theta^{n_u} e^{-\theta\sum_{i = 1}^n x_i}.
$$
where one should note that $\theta$ is raised to the number of uncensored observations, $n_u$ while the sum in the exponential term includes both uncensored and censored observations.

By Bayes' theorem, the posterior distribution is again a Gamma distribution
$$
\begin{align}
p(\theta \vert x_1,\ldots,x_n) & \propto p(x_1,\ldots,x_n \vert \theta)p(\theta) \\
& \propto \theta^{n_u} e^{-\theta\sum_{i = 1}^n x_i} \times \theta^{\alpha-1}e^{-\beta\theta} \\
& = \theta^{\alpha + n_u - 1} e^{ -\theta(\beta + \sum_{i = 1}^n x_i)},
\end{align}
$$
which we recognize as proportional to the following Gamma distribution
$$
\theta \vert x_1,\ldots,x_n \sim \mathrm{Gamma}(\alpha + n_u,\beta + \sum\nolimits_{i=1}^n x_i).
$$ 

The code below plots both:

- the posterior from the previous exercise (a) with only the uncensored data and 
- the posterior from with all data.

The posterior with all data is more informative and concentrates on smaller $\theta$ values. Since smaller $\theta$ values correspond to longer expected survival times, this is makes sense since the censored patients were still alive at the end of the study.

```{r}
# Summarize the data needed for the posterior, grouped by `status`:
data_summary <- lung %>% group_by(status) %>% summarize(n = n(), sum_x = sum(time))
```

```{r}
# Set up prior hyperparameters
alpha_prior <- 3   # shape parameter
beta_prior <- 300  # rate parameter

# Compute posterior hyperparameters - only uncensored data
alpha_post_u <- alpha_prior + data_summary$n[2] # second row is uncensored data (status = 2)  
beta_post_u <- beta_prior + data_summary$sum_x[2] # sum over uncensored observations

# Compute posterior hyperparameters - all data
alpha_post_all <- alpha_prior + data_summary$n[2] # note: this is still n_u 
beta_post_all <- beta_prior + sum(data_summary$sum_x) # sum over all observations   
```

```{r}
# Plot the prior and the two posterior densities 
thetaGrid <- seq(0, 0.03, length.out = 1000)
prior_density <- dgamma(thetaGrid, shape = alpha_prior, rate = beta_prior)
posterior_density_u <- dgamma(thetaGrid, shape = alpha_post_u, rate = beta_post_u)
posterior_density_all <- dgamma(thetaGrid, shape = alpha_post_all, rate = beta_post_all)


df <- data.frame(
  thetaGrid = thetaGrid, 
  prior = prior_density, 
  posterior_uncensored = posterior_density_u,
  posterior_all = posterior_density_all
)

df_long <- df %>% pivot_longer(-thetaGrid, names_to = "density_type", values_to = "density")

ggplot(df_long) +
  aes(x = thetaGrid, y = density, color = density_type) +
  geom_line() +
  scale_colour_manual(
    breaks = c("prior", "posterior_uncensored", "posterior_all"), 
    values = c(colors[2], colors[3], colors[4])) +
  labs(title = "Exercise 2.2", x = expression(theta), y = "Density", color = "") + 
  theme_minimal()
```


The code below plots the histogram and the pdf of the exponential model with the parameter $\theta$ set equal to the posterior mode. It is clear that the exponential model with its monotonically decreasing density is not fitting the data well.
```{r}
postMode = df$thetaGrid[which.max(df$posterior_all)]

ggplot(lung, aes(time)) +
  geom_histogram(aes(y = after_stat(density), fill = "Data"), bins = 30) +
  stat_function(fun = dexp, args = list(rate = postMode), lwd = 1, 
                aes(color = "Exponential fit"),
  ) +
  labs(title = "Exercise 2.2c - Exponential model fit to lung cancer survival", x = "days", y = "Density") + 
  scale_fill_manual("", values = colors[5]) +
  scale_color_manual("", values = colors[3]) +
  theme_minimal()
```

:::
